# Implementation Plan: Termux Bootstrap Installation

**Feature ID**: 003
**Feature**: Termux Bootstrap Installation
**Created**: 2025-10-22
**Status**: Planning Complete
**Estimated Effort**: 12-16 hours (1-2 days)

---

## Overview

This implementation plan translates the feature specification into a concrete technical design for installing the Termux bootstrap system in ConvoCLI. The bootstrap enables Linux command execution by providing bash, coreutils, and package management tools (~150MB extracted).

**Critical Path**: This feature unblocks all future development (Features 004-006) by transforming ConvoCLI from infrastructure-only to a functional Linux terminal.

---

## Technical Context

### Architecture Components

**New Components to Implement**:
1. **BootstrapManager** (Service)
   - Orchestrates bootstrap installation lifecycle
   - State machine for installation phases
   - Dependency: TerminalRepository (existing)

2. **BootstrapDownloader** (Service)
   - Downloads bootstrap archive from Termux repository
   - HTTP client with progress tracking
   - Resume capability for interrupted downloads
   - Checksum verification
   - Dependency: HTTP Client library

3. **BootstrapExtractor** (Service)
   - Extracts ZIP archive to app files directory
   - Atomic extraction (temp → rename)
   - Symlink preservation via SYMLINKS.txt
   - Dependency: Standard Java ZipInputStream

4. **BootstrapValidator** (Service)
   - Validates bootstrap installation integrity
   - Tests bash and core utilities execution
   - Verifies file permissions

5. **InstallationViewModel** (ViewModel)
   - UI state management for installation screen
   - Progress tracking (download, extract, configure)
   - Error handling and retry logic
   - Dependency: Hilt, StateFlow

6. **InstallationScreen** (Compose UI)
   - Progress indicators
   - Cancel button
   - Error messages
   - Success/failure states

### Technology Decisions

**HTTP Client**: Ktor Client Android
- Kotlin-native HTTP client
- Coroutines support
- Progress callbacks
- **Status**: APPROVED ✅ (already in tech-stack.md for future use)

**Archive Extraction**: Standard Java ZipInputStream
- Built-in Java library for ZIP archives
- No external dependencies required
- Streaming extraction with low memory usage
- **Status**: APPROVED ✅ (standard library)

**Progress Tracking**: StateFlow + Kotlin Flow
- Reactive progress updates
- **Status**: APPROVED ✅

**File I/O**: Kotlin stdlib + Android File APIs
- Standard file operations
- **Status**: APPROVED ✅

**Architecture Pattern**: Clean Architecture + MVI
- ViewModel → Repository → Service
- **Status**: APPROVED ✅

### Android-Specific Considerations

**Storage**:
- App private directory: `/data/data/com.convocli/files/`
- No runtime permissions required (app-private storage)
- Bootstrap path: `$FILES_DIR/usr/`

**Architecture Detection**:
- `Build.SUPPORTED_ABIS[0]` for CPU architecture
- Map to Termux bootstrap variants:
  - `arm64-v8a` → bootstrap-aarch64
  - `armeabi-v7a` → bootstrap-arm
  - `x86_64` → bootstrap-x86_64
  - `x86` → bootstrap-i686

**Background Work**:
- Download/extraction in coroutines (Dispatchers.IO)
- UI updates on Dispatchers.Main
- Cancellation via Job cancellation

**File Permissions**:
- `File.setExecutable()` for binaries
- Verify with `File.canExecute()`

---

## Tech Stack Compliance Report
<!-- Auto-generated by SpecSwarm tech stack validation -->

### ✅ Approved Technologies (already in stack)

1. **Kotlin 1.9+**
   - Primary language for all new code
   - Coroutines for async operations

2. **Jetpack Compose 1.9.3**
   - Installation UI screen
   - Progress indicators

3. **Hilt 2.48+**
   - Dependency injection for services

4. **StateFlow / SharedFlow**
   - Installation progress tracking
   - UI state management

5. **Ktor Client**
   - HTTP downloads
   - Already approved for future network features

6. **Kotlin Coroutines**
   - Async download/extraction
   - Structured concurrency

7. **Room** (indirect)
   - Store installation state/metadata

8. **DataStore**
   - Persist bootstrap installation status

### ➕ New Technologies (auto-add to tech-stack)

**None** - All required technologies already approved in tech-stack.md

### ⚠️ Conflicting Technologies

**None detected**

### ❌ Prohibited Technologies

**None detected** - all technologies comply with tech-stack.md

### Tech Stack Validation Result

✅ **PASS** - All technologies already approved in tech-stack.md

**Changes to tech-stack.md**:
- None required - using standard Java libraries only

---

## Constitution Check

### Principle 1: Kotlin Coding Standards

✅ **COMPLIANT**
- All new code will be Kotlin
- Follow Kotlin coding conventions
- ktlint validation before commit
- KDoc for all public APIs

### Principle 2: Clean Architecture

✅ **COMPLIANT**
- UI → ViewModel → Repository → Service
- Clear separation of concerns:
  - **Presentation**: InstallationScreen (Compose)
  - **Logic**: InstallationViewModel (state management)
  - **Domain**: BootstrapManager (orchestration)
  - **Data**: BootstrapDownloader, BootstrapExtractor (implementation)

### Principle 3: Compose-First UI

✅ **COMPLIANT**
- Installation screen: 100% Compose
- No XML layouts
- Material 3 components
- StateFlow for reactive UI

### Principle 4: Testability

✅ **COMPLIANT**
- Repository interfaces for testability
- Fake implementations for tests
- Unit tests: BootstrapManager, ViewModel
- Integration tests: Downloader, Extractor, Validator
- UI tests: InstallationScreen

### Principle 5: Technology Stack Adherence

✅ **COMPLIANT**
- All technologies already approved in tech-stack.md
- No new dependencies required
- Ktor for HTTP (approved)
- Standard Java libraries for ZIP extraction (built-in)

---

## Phase 0: Research & Technical Decisions

### Research Tasks

#### R0.1: Termux Bootstrap Repository Structure
**Status**: NEEDS RESEARCH

**Questions**:
- What is the exact URL structure for bootstrap downloads?
- How are architectures mapped in download URLs?
- What checksum format is used (SHA256, MD5)?
- Are there fallback mirrors available?

**Research Method**:
- Review Termux official documentation
- Inspect termux-app source code for bootstrap download logic
- Document current bootstrap version and URL patterns

**Output**: Document in `research.md` → Bootstrap Repository section

---

#### R0.2: ZIP Archive Extraction in Android
**Status**: NEEDS RESEARCH

**Questions**:
- What library should be used for ZIP extraction (standard Java vs external)?
- Are there any Android-specific issues (permissions, file paths)?
- What's the memory usage during extraction?
- How to preserve Unix symlinks on Android?

**Research Method**:
- Review Termux app source code for extraction implementation
- Check standard Java ZipInputStream capabilities
- Verify symlink preservation approach on Android file systems

**Output**: Document in `research.md` → Archive Extraction section

---

#### R0.3: Bootstrap Integrity Verification
**Status**: NEEDS RESEARCH

**Questions**:
- What checksum algorithm does Termux use?
- Where are checksums published?
- How to verify archive integrity before extraction?

**Research Method**:
- Check Termux repository for checksum files
- Review termux-app bootstrap verification code

**Output**: Document in `research.md` → Integrity Verification section

---

#### R0.4: File Permissions on Android
**Status**: NEEDS RESEARCH

**Questions**:
- Does `File.setExecutable()` work reliably on Android 8.0+?
- Are there SELinux restrictions on execute permissions?
- How to verify permissions were set correctly?

**Research Method**:
- Test `File.setExecutable()` on various Android versions
- Review Android file permission documentation
- Check for known issues with execute permissions in app private storage

**Output**: Document in `research.md` → File Permissions section

---

#### R0.5: Download Resume Strategy
**Status**: NEEDS RESEARCH

**Questions**:
- Does Termux repository support HTTP range requests?
- How to implement resume from partial download?
- How to validate partial download integrity?

**Research Method**:
- Test HTTP HEAD request to Termux repository for Accept-Ranges header
- Review Ktor Client range request support
- Design resume strategy (save position, verify partial file)

**Output**: Document in `research.md` → Download Resume section

---

### Technical Decisions (Post-Research)

All technical decisions will be documented in `research.md` after completing research tasks above.

**Decision Points**:
1. Exact bootstrap download URL pattern
2. Checksum verification approach
3. Archive extraction approach (standard Java vs external library)
4. Download resume strategy
5. File permission setting approach
6. Error recovery strategies

---

## Phase 1: Design & Contracts

### Data Model

See: `data-model.md` for complete entity definitions

**Key Entities**:

1. **BootstrapInstallation**
   ```kotlin
   data class BootstrapInstallation(
       val status: InstallationStatus,
       val version: String?,
       val installedPath: String?,
       val installationDate: Long?,
       val lastValidated: Long?
   )
   ```

2. **InstallationProgress**
   ```kotlin
   data class InstallationProgress(
       val phase: InstallationPhase,
       val bytesDownloaded: Long,
       val totalBytes: Long,
       val filesExtracted: Int,
       val totalFiles: Int,
       val estimatedTimeRemaining: Long?,
       val error: BootstrapError?
   )
   ```

3. **InstallationStatus** (enum)
   - `NOT_INSTALLED`
   - `DOWNLOADING`
   - `EXTRACTING`
   - `CONFIGURING`
   - `VERIFYING`
   - `INSTALLED`
   - `FAILED`

4. **InstallationPhase** (enum)
   - `DETECTING`
   - `DOWNLOADING`
   - `EXTRACTING`
   - `CONFIGURING_PERMISSIONS`
   - `CONFIGURING_ENVIRONMENT`
   - `VERIFYING`
   - `COMPLETE`

### API Contracts

See: `contracts/` directory for complete interface definitions

#### BootstrapManager Interface

```kotlin
interface BootstrapManager {
    /**
     * Check if bootstrap is installed and valid
     */
    suspend fun isInstalled(): Boolean

    /**
     * Get current installation status
     */
    fun getInstallationStatus(): Flow<BootstrapInstallation>

    /**
     * Install bootstrap with progress tracking
     * @return Flow of installation progress
     */
    fun install(): Flow<InstallationProgress>

    /**
     * Cancel ongoing installation
     */
    suspend fun cancelInstallation()

    /**
     * Validate existing installation
     */
    suspend fun validateInstallation(): ValidationResult

    /**
     * Delete bootstrap installation
     */
    suspend fun deleteInstallation()
}
```

#### BootstrapDownloader Interface

```kotlin
interface BootstrapDownloader {
    /**
     * Download bootstrap archive for device architecture
     * @return Flow of download progress (bytes downloaded, total bytes)
     */
    fun download(
        architecture: String,
        destination: File
    ): Flow<DownloadProgress>

    /**
     * Resume interrupted download
     */
    suspend fun resumeDownload(
        architecture: String,
        destination: File,
        bytesAlreadyDownloaded: Long
    ): Flow<DownloadProgress>

    /**
     * Verify downloaded archive integrity
     */
    suspend fun verifyChecksum(file: File, expectedChecksum: String): Boolean

    /**
     * Get download URL for architecture
     */
    fun getDownloadUrl(architecture: String): String
}
```

#### BootstrapExtractor Interface

```kotlin
interface BootstrapExtractor {
    /**
     * Extract bootstrap archive
     * @return Flow of extraction progress (files extracted, total files)
     */
    fun extract(
        archiveFile: File,
        destinationDir: File
    ): Flow<ExtractionProgress>

    /**
     * Verify extraction completed successfully
     */
    suspend fun verifyExtraction(destinationDir: File): Boolean
}
```

### Architecture Diagrams

```
┌─────────────────────────────────────────────────────┐
│                  InstallationScreen                 │
│              (Jetpack Compose UI)                   │
│  ┌──────────────────────────────────────────────┐   │
│  │  Progress Bar, Phase Label, Cancel Button    │   │
│  └──────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────┘
                     │ StateFlow<InstallationProgress>
                     ▼
┌─────────────────────────────────────────────────────┐
│            InstallationViewModel                    │
│              (MVI State Management)                 │
│  ┌──────────────────────────────────────────────┐   │
│  │  State: InstallationProgress                  │   │
│  │  Actions: install(), cancel(), retry()        │   │
│  └──────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────┘
                     │ Repository calls
                     ▼
┌─────────────────────────────────────────────────────┐
│              BootstrapManager                       │
│           (Orchestration Service)                   │
│  ┌──────────────────────────────────────────────┐   │
│  │  Phase 1: Detection                           │   │
│  │  Phase 2: Download (via Downloader)           │   │
│  │  Phase 3: Extract (via Extractor)             │   │
│  │  Phase 4: Configure Permissions               │   │
│  │  Phase 5: Configure Environment               │   │
│  │  Phase 6: Verify (via Validator)              │   │
│  └──────────────────────────────────────────────┘   │
└────────┬──────────────┬──────────────┬──────────────┘
         │              │              │
         ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Downloader   │ │  Extractor   │ │  Validator   │
│ (Ktor HTTP)  │ │ (Java ZIP)   │ │(Shell Exec)  │
└──────────────┘ └──────────────┘ └──────────────┘
```

### Component Interactions

**Installation Flow**:
1. User launches app → ViewModel checks installation status
2. If not installed → ViewModel calls `BootstrapManager.install()`
3. BootstrapManager orchestrates:
   - Detection: Check if already installed
   - Download: `BootstrapDownloader.download()` → Progress updates
   - Extract: `BootstrapExtractor.extract()` → Progress updates
   - Configure: Set permissions and environment variables
   - Verify: `BootstrapValidator.validate()` → Success/failure
4. ViewModel emits progress states to UI
5. UI updates progress indicators
6. On completion: Navigate to terminal screen
7. On error: Show error message with retry button

**Cancellation Flow**:
1. User taps cancel button
2. ViewModel calls `BootstrapManager.cancelInstallation()`
3. BootstrapManager cancels coroutine jobs
4. Cleanup partial downloads and extractions
5. Reset state to `NOT_INSTALLED`
6. UI shows cancellation message

---

## Phase 2: Implementation Tasks

### Task Breakdown

#### Sprint 1: Core Infrastructure (4-5 hours)

**Task 1.1**: Implement BootstrapManager Service
- Create `BootstrapManager` interface
- Implement state machine for installation phases
- Add installation status persistence (DataStore)
- Add architecture detection logic
- **Tests**: Unit tests for state transitions
- **Estimated**: 2 hours

**Task 1.2**: Implement BootstrapDownloader Service
- Create `BootstrapDownloader` interface
- Integrate Ktor Client for HTTP downloads
- Implement progress tracking via Flow
- Add checksum verification
- Add download resume support
- **Tests**: Unit tests with fake HTTP responses, integration test with real download (small file)
- **Estimated**: 2.5 hours

**Task 1.3**: Implement BootstrapExtractor Service
- Create `BootstrapExtractor` interface
- Use standard Java ZipInputStream
- Implement streaming extraction
- Preserve symlinks via SYMLINKS.txt
- Add atomic extraction (temp → rename)
- **Tests**: Unit tests with test archive, integration test with real ZIP
- **Estimated**: 2 hours

#### Sprint 2: Validation & Configuration (3-4 hours)

**Task 2.1**: Implement BootstrapValidator Service
- Create `BootstrapValidator` interface
- Execute bash --version command
- Test core utilities (ls, pwd, echo, cat, grep)
- Verify directory structure
- **Tests**: Integration tests (require bootstrap or mock)
- **Estimated**: 1.5 hours

**Task 2.2**: Implement Permission Configuration
- Set execute permissions on binaries
- Verify permissions applied correctly
- Handle permission errors
- **Tests**: Integration tests on Android device/emulator
- **Estimated**: 1 hour

**Task 2.3**: Implement Environment Configuration
- Set PREFIX, PATH, HOME, TMPDIR, SHELL
- Persist configuration
- Validate on app launch
- **Tests**: Unit tests for environment setup, integration test for persistence
- **Estimated**: 1 hour

#### Sprint 3: UI & State Management (4-5 hours)

**Task 3.1**: Implement InstallationViewModel
- Create ViewModel with Hilt injection
- Implement MVI pattern (state, actions, effects)
- Map installation progress to UI state
- Handle errors and retry logic
- Add cancellation support
- **Tests**: Unit tests with fake BootstrapManager
- **Estimated**: 2 hours

**Task 3.2**: Implement InstallationScreen UI
- Create Compose installation screen
- Progress indicators (phase, percentage, ETA)
- Cancel button
- Error message display
- Success/failure states
- **Tests**: Compose UI tests
- **Estimated**: 2.5 hours

#### Sprint 4: Integration & Testing (2-3 hours)

**Task 4.1**: End-to-End Integration Tests
- Test complete installation flow on device/emulator
- Test cancellation mid-download
- Test cancellation mid-extraction
- Test error recovery (network failure, storage full)
- Test bootstrap validation after installation
- **Estimated**: 2 hours

**Task 4.2**: Update Feature 002 Integration Tests
- Ensure existing tests pass with bootstrap installed
- Verify real command execution works
- Update test documentation
- **Estimated**: 1 hour

#### Sprint 5: Polish & Documentation (1-2 hours)

**Task 5.1**: Error Handling Polish
- Improve error messages (user-friendly)
- Add specific error codes
- Add diagnostic logging
- **Estimated**: 1 hour

**Task 5.2**: Documentation
- Update CLAUDE.md with bootstrap installation details
- Create quickstart.md for feature
- Document troubleshooting steps
- **Estimated**: 1 hour

---

## Dependencies & Prerequisites

### External Dependencies

**New Gradle Dependencies**:
```kotlin
// HTTP Client
implementation("io.ktor:ktor-client-android:2.3.5")
implementation("io.ktor:ktor-client-core:2.3.5")

// Archive Extraction: None required (using standard Java ZipInputStream)
```

### Prerequisites

1. **Feature 002 Complete**: Terminal infrastructure must be functional
2. **Network Permission**: Add `INTERNET` permission to AndroidManifest.xml
3. **Storage Space**: Minimum 200MB available
4. **Test Device**: Android device/emulator with API 26+ for testing

---

## Testing Strategy

### Unit Tests

**Target Coverage**: 80%+

**Components to Test**:
- BootstrapManager state machine
- InstallationViewModel state transformations
- Downloader progress calculations
- Extractor file operations
- Validator command execution

**Mocking Strategy**:
- Fake implementations for repositories
- MockK for external dependencies (HTTP, File I/O)

### Integration Tests

**Scenarios**:
1. Complete installation flow (download → extract → configure → verify)
2. Cancellation during download
3. Cancellation during extraction
4. Resume after network failure
5. Retry after extraction failure
6. Validation of installed bootstrap

**Test Environment**:
- Android device/emulator with API 26+
- Sufficient storage space
- Network connectivity

### UI Tests

**Scenarios**:
1. Progress indicators update during installation
2. Cancel button is responsive
3. Error messages display correctly
4. Success state transitions to terminal screen

### Manual Testing Checklist

- [ ] Installation completes successfully on arm64 device
- [ ] Installation completes successfully on x86 emulator
- [ ] Progress indicators are smooth and accurate
- [ ] Cancel button works at all phases
- [ ] Retry after failure works
- [ ] Bootstrap validation catches corrupted installations
- [ ] Terminal executes real commands after installation
- [ ] Feature 002 tests pass with real commands

---

## Risk Mitigation

### High Risks

**Risk 1**: Download failures due to network issues
- **Mitigation**: Implement retry logic with exponential backoff
- **Mitigation**: Support download resume
- **Mitigation**: Provide clear error messages with retry button

**Risk 2**: Storage space runs out during extraction
- **Mitigation**: Check available space before starting
- **Mitigation**: Clean up partial extractions on failure
- **Mitigation**: Provide clear error message with space requirement

**Risk 3**: Archive extraction fails or corrupts files
- **Mitigation**: Verify checksum before extraction
- **Mitigation**: Atomic extraction (temp directory → rename on success)
- **Mitigation**: Validation step after extraction

### Medium Risks

**Risk 4**: Termux repository URL changes
- **Mitigation**: Configuration-based URLs (easy to update)
- **Mitigation**: Fallback to alternative mirrors
- **Mitigation**: Error message with manual download option

**Risk 5**: Performance issues on old devices
- **Mitigation**: Optimize extraction (streaming, not loading full archive)
- **Mitigation**: Background coroutines (don't block UI)
- **Mitigation**: Progress indicators to set expectations

---

## Success Criteria

This feature is complete when:

1. ✅ Bootstrap downloads successfully on all supported architectures
2. ✅ Bootstrap extracts correctly without corruption
3. ✅ Bash and core utilities execute successfully
4. ✅ All Feature 002 integration tests pass with real commands
5. ✅ Installation completes in under 5 minutes on 3G+ connections
6. ✅ Installation can be cancelled at any point with cleanup
7. ✅ Failed installations can be retried successfully
8. ✅ Progress indicators provide clear feedback
9. ✅ 80%+ unit test coverage
10. ✅ Manual testing passes on multiple devices/architectures

---

## Next Steps

**After Planning Approval**:

1. ✅ **Phase 0 Complete**: Run research tasks (R0.1 through R0.5)
   - Document findings in `research.md`
   - Resolve all NEEDS RESEARCH items
   - Confirm technical decisions

2. ✅ **Phase 1 Complete**: Create design artifacts
   - Generate `data-model.md` with entity definitions
   - Create API contracts in `contracts/` directory
   - Create `quickstart.md` for developer onboarding
   - Update agent context file (`.claude/context.md` or `.cursorrules`)

3. **Ready for `/specswarm:tasks`**: Convert plan into executable task list

4. **Ready for `/specswarm:implement`**: Begin implementation

---

**Plan Status**: ✅ COMPLETE - Ready for Research Phase

